<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixeiro Viajante - Algoritmo Genético</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .matrix-input {
            @apply h-10 text-center border border-gray-300 rounded-md p-1;
            width: 50px;
        }

        .matrix-input:disabled {
            @apply bg-gray-100 text-gray-500;
        }

        .matrix-header {
            @apply h-10 flex items-center justify-center font-bold text-gray-600;
            width: 50px;
        }

        .matrix-input:disabled {
            background: #efefef;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans p-6 md:p-10">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
        <header class="bg-gray-800 text-white p-6">
            <h1 class="text-3xl font-bold">Trabalho de Algoritmos Genéticos</h1>
            <p class="text-lg text-gray-300 mt-1">Alunos: Daniel Sansão Araldi, Breno Capraro de Souza e Arthur Moser</p>
        </header>

        <main class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 space-y-6">
                <section class="bg-gray-50 p-5 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Configurar Cidades</h2>
                    <label for="numCidades" class="block text-sm font-medium text-gray-600 mb-2">Número de Cidades (3 a
                        20):</label>
                    <input type="number" id="numCidades" min="3" max="20" value="7"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <button id="btnGerarMatriz"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 mt-4">
                        Gerar Matriz de Distâncias
                    </button>
                    <button id="btnPreencherExemplo"
                        class="w-full bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500 transition duration-300 mt-2 text-sm">
                        Usar Exemplo (7 Cidades)
                    </button>
                </section>

                <section class="bg-gray-50 p-5 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Parâmetros do AG</h2>
                    <div class="space-y-4">
                        
                        <div>
                            <label for="numGeracoesMax" class="block text-sm font-medium text-gray-600 mb-2">Gerações Máximas (1-1000):</label>
                            <input type="number" id="numGeracoesMax" min="1" max="1000" value="100" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="limiteParada" class="block text-sm font-medium text-gray-600 mb-2">Parada Antecipada (1-100):</label>
                            <input type="number" id="limiteParada" min="1" max="100" value="5" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>

                        <div class="text-sm text-gray-500 pt-2">
                            <p>• População: <strong class="text-gray-700">Fib(N)</strong>.</p>
                            <p>• Torneio: <strong class="text-gray-700">3</strong>.</p>
                        </div>
                    </div>
                </section>

                <section>
                    <button id="btnIniciar"
                        class="w-full bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 transition duration-300 text-lg font-semibold shadow-lg">
                        Iniciar Algoritmo
                    </button>
                </section>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <section class="bg-gray-50 p-5 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Matriz de Distâncias (Simétrica)</h2>
                    <p class="text-sm text-gray-500 mb-4">Preencha apenas a diagonal superior. A diagonal inferior será
                        espelhada automaticamente.</p>
                    <div id="matrizContainer" class="overflow-x-auto">
                    </div>
                    <button id="btnGerarAleatoria"
                        class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 transition duration-300 mt-4 text-sm font-medium">
                        Gerar Matriz Aleatória
                    </button>
                </section>

                <section class="bg-gray-50 p-5 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Resultados</h2>
                    <div id="loading" class="hidden text-center py-4">
                        <div
                            class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin">
                        </div>
                        <p class="text-gray-600 mt-2">Calculando...</p>
                    </div>
                    <div id="resultados" class="hidden space-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-600">Melhor Rota Encontrada:</h3>
                            <p id="melhorRota" class="text-blue-600 font-mono text-lg break-words"></p>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-600">Distância Total:</h3>
                            <p id="melhorDistancia" class="text-blue-600 font-mono text-2xl font-bold"></p>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-md font-medium text-gray-600">Log de Execução:</h3>
                            <pre id="log"
                                class="bg-gray-900 text-white text-sm p-4 rounded-md h-60 overflow-y-auto font-mono"></pre>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        const numCidadesEl = document.getElementById('numCidades');
        const btnGerarMatrizEl = document.getElementById('btnGerarMatriz');
        const btnPreencherExemploEl = document.getElementById('btnPreencherExemplo');
        const matrizContainerEl = document.getElementById('matrizContainer');
        const btnGerarAleatoriaEl = document.getElementById('btnGerarAleatoria');
        
        const numGeracoesMaxEl = document.getElementById('numGeracoesMax');
        const limiteParadaEl = document.getElementById('limiteParada');

        const btnIniciarEl = document.getElementById('btnIniciar');
        const loadingEl = document.getElementById('loading');
        const resultadosEl = document.getElementById('resultados');
        const melhorRotaEl = document.getElementById('melhorRota');
        const melhorDistanciaEl = document.getElementById('melhorDistancia');
        const logEl = document.getElementById('log');

        let N = 0; 

        btnGerarMatrizEl.addEventListener('click', () => {
            N = parseInt(numCidadesEl.value);
            if (N < 3 || N > 20) {
                alert("Por favor, insira um número de cidades entre 3 e 20.");
                return;
            }
            gerarGridMatriz(N);
        });

        btnPreencherExemploEl.addEventListener('click', () => {
            numCidadesEl.value = 7;
            N = 7;
            gerarGridMatriz(N);
            preencherExemplo();
        });

        btnGerarAleatoriaEl.addEventListener('click', () => {
            if (N < 3) {
                alert("Gere a matriz primeiro (mínimo 3 cidades).");
                return;
            }
            gerarMatrizAleatoria(N);
        });

        btnIniciarEl.addEventListener('click', () => {
            const matriz = lerMatrizDaUI();
            if (!matriz) {
                alert("Matriz inválida. Verifique se todas as distâncias da diagonal superior foram preenchidas.");
                return;
            }

            const numGeracoesMax = parseInt(numGeracoesMaxEl.value);
            const limiteParada = parseInt(limiteParadaEl.value);

            if (isNaN(numGeracoesMax) || numGeracoesMax < 1 || numGeracoesMax > 1000) {
                 alert("Por favor, insira um número de Gerações Máximas entre 1 e 1000.");
                 return;
            }
            if (isNaN(limiteParada) || limiteParada < 1 || limiteParada > 100) {
                 alert("Por favor, insira um número de Parada Antecipada entre 1 e 100.");
                 return;
            }

            logEl.textContent = '';
            resultadosEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');

            setTimeout(() => {
                iniciarGA(matriz, numGeracoesMax, limiteParada); 
            }, 50);
        });

        function gerarGridMatriz(tamanho) {
            matrizContainerEl.innerHTML = ''; 
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = `repeat(${tamanho + 1}, auto)`;
            grid.style.gap = '4px';

            grid.appendChild(document.createElement('div')); 
            for (let j = 0; j < tamanho; j++) {
                const header = document.createElement('div');
                header.className = 'matrix-header';
                header.textContent = `${j + 1}`;
                grid.appendChild(header);
            }

            for (let i = 0; i < tamanho; i++) {
                const header = document.createElement('div');
                header.className = 'matrix-header';
                header.textContent = `${i + 1}`;
                grid.appendChild(header);

                for (let j = 0; j < tamanho; j++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `cell-${i}-${j}`;
                    input.className = 'matrix-input';
                    input.min = "0";

                    if (i === j) {
                        input.value = 0;
                        input.disabled = true; 
                    } else if (j < i) {
                        input.disabled = true; 
                    } else {
                        input.addEventListener('input', (e) => {
                            const symmetricCell = document.getElementById(`cell-${j}-${i}`);
                            if (symmetricCell) {
                                symmetricCell.value = e.target.value;
                            }
                        });
                    }
                    grid.appendChild(input);
                }
            }
            matrizContainerEl.appendChild(grid);
        }

        function lerMatrizDaUI() {
            const matriz = Array.from({ length: N }, () => Array(N).fill(0));
            let valida = true;

            for (let i = 0; i < N; i++) {
                for (let j = 0; j < N; j++) {
                    if (i === j) continue; 

                    const cell = document.getElementById(`cell-${i}-${j}`);
                    if (!cell) return null; 

                    const valor = parseFloat(cell.value);

                    if (j > i) { 
                        if (isNaN(valor) || valor <= 0) {
                            valida = false; 
                        }
                        matriz[i][j] = valor;
                        matriz[j][i] = valor; 
                    }
                }
            }
            return valida ? matriz : null;
        }

        function preencherExemplo() {
            const distancias = [
                [0, 281, 338, 299, 398, 351, 448], 
                [0, 0, 61, 43, 357, 330, 263],   
                [0, 0, 0, 42, 300, 273, 206],   
                [0, 0, 0, 0, 339, 312, 246],   
                [0, 0, 0, 0, 0, 102, 154],   
                [0, 0, 0, 0, 0, 0, 236],   
                [0, 0, 0, 0, 0, 0, 0]    
            ];

            for (let i = 0; i < N; i++) {
                for (let j = i + 1; j < N; j++) { 
                    const cell = document.getElementById(`cell-${i}-${j}`);
                    const cellSimetrica = document.getElementById(`cell-${j}-${i}`);
                    
                    if (cell && distancias[i] && distancias[i][j] !== undefined) {
                        const valor = distancias[i][j];
                        cell.value = valor;
                        if(cellSimetrica) {
                            cellSimetrica.value = valor;
                        }
                    }
                }
            }
        }
        
        function gerarMatrizAleatoria(tamanho) {
            log("Gerando matriz aleatória...");
            for (let i = 0; i < tamanho; i++) {
                for (let j = i + 1; j < tamanho; j++) { 
                    const cell = document.getElementById(`cell-${i}-${j}`);
                    const cellSimetrica = document.getElementById(`cell-${j}-${i}`);
                    
                    const distancia = Math.floor(Math.random() * 491) + 10; 
                    
                    if (cell && cellSimetrica) {
                        cell.value = distancia;
                        cellSimetrica.value = distancia;
                    }
                }
            }
            log("Matriz aleatória preenchida.");
        }
        
        function embaralhar(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function fibonacci(n) {
            if (n <= 1) return 1;
            if (n === 2) return 1; 
            let a = 1, b = 1;
            for (let i = 3; i <= n; i++) {
                let temp = a + b;
                a = b;
                b = temp;
            }
            return b;
        }

        function log(mensagem) {
            console.log(mensagem); 
            logEl.textContent += `> ${mensagem}\n`;
            logEl.scrollTop = logEl.scrollHeight; 
        }

        function iniciarGA(matrizDistancias, numGeracoesMax, limiteParada) { 
            log("Iniciando Algoritmo Genético...");

            const N = matrizDistancias.length;
            const tamTorneioFixo = 3; 
            let geracoesSemMelhoria = 0;

            let tamPopulacao = fibonacci(N);
            log(`Tamanho da População: Fib(${N}) = ${tamPopulacao} rotas.`);

            let tamTorneio = tamTorneioFixo; 
            if (tamPopulacao < tamTorneio) {
                log(`Aviso: Tamanho do torneio (${tamTorneio}) é maior que a população (${tamPopulacao}).`);
                tamTorneio = tamPopulacao;
                log(`Ajustando torneio para ${tamTorneio}.`);
            }

            log(`Gerações Máximas: ${numGeracoesMax}`);
            log(`Parada Antecipada: ${limiteParada} gerações sem melhoria.`);
            log(`Tamanho do Torneio: ${tamTorneio} (fixo em 3, ajustado se necessário)`);
            log("---");

            let populacao = [];
            const cidadesBase = Array.from({ length: N }, (_, i) => i + 1); 

            for (let i = 0; i < tamPopulacao; i++) {
                const cidadesEmbaralhadas = embaralhar([...cidadesBase.slice(1)]);
                const rota = [1, ...cidadesEmbaralhadas, 1]; 
                populacao.push({
                    rota: rota,
                    fitness: 1 / calcularDistanciaTotal(rota, matrizDistancias)
                });
            }

            let melhorIndividuoGlobal = [...populacao].sort((a, b) => b.fitness - a.fitness)[0];
            log(`Geração 0: Melhor Distância = ${1 / melhorIndividuoGlobal.fitness}`);

            for (let g = 1; g <= numGeracoesMax; g++) {
                let novaPopulacao = [];

                novaPopulacao.push(melhorIndividuoGlobal);

                while (novaPopulacao.length < tamPopulacao) {
                    const pai1 = selecaoTorneio(populacao, tamTorneio);
                    const pai2 = selecaoTorneio(populacao, tamTorneio);

                    const [filho1Rota, filho2Rota] = crossoverPMX(pai1.rota, pai2.rota);

                    const filho1Mutado = mutacaoTroca(filho1Rota);
                    const filho2Mutado = mutacaoTroca(filho2Rota);

                    novaPopulacao.push({
                        rota: filho1Mutado,
                        fitness: 1 / calcularDistanciaTotal(filho1Mutado, matrizDistancias)
                    });
                    
                    if (novaPopulacao.length < tamPopulacao) {
                         novaPopulacao.push({
                            rota: filho2Mutado,
                            fitness: 1 / calcularDistanciaTotal(filho2Mutado, matrizDistancias)
                        });
                    }
                }

                populacao = novaPopulacao;

                const melhorIndividuoAtual = [...populacao].sort((a, b) => b.fitness - a.fitness)[0];

                if (melhorIndividuoAtual.fitness > melhorIndividuoGlobal.fitness) {
                    melhorIndividuoGlobal = melhorIndividuoAtual;
                    geracoesSemMelhoria = 0; 
                    
                    if (g % 10 === 0 || g === 1 || g === numGeracoesMax) {
                        log(`Geração ${g}: Nova Melhor Distância = ${Math.round(1 / melhorIndividuoGlobal.fitness * 100) / 100}`);
                    }
                } else {
                    geracoesSemMelhoria++;
                }

                if (geracoesSemMelhoria >= limiteParada) {
                    log(`Geração ${g}: Parando. A melhor rota não muda há ${limiteParada} gerações.`);
                    break; 
                }
            } 

            log("---");
            log("Evolução concluída.");
            
            const distanciaFinal = Math.round(1 / melhorIndividuoGlobal.fitness * 100) / 100;
            const rotaFinal = melhorIndividuoGlobal.rota.join(' -> ');

            log(`Melhor Rota: ${rotaFinal}`);
            log(`Distância Final: ${distanciaFinal}`);

            melhorRotaEl.textContent = rotaFinal;
            melhorDistanciaEl.textContent = distanciaFinal;
            loadingEl.classList.add('hidden');
            resultadosEl.classList.remove('hidden');
        }

        function calcularDistanciaTotal(rota, matriz) {
            let distancia = 0;
            for (let i = 0; i < rota.length - 1; i++) {
                const cidadeA = rota[i] - 1; 
                const cidadeB = rota[i+1] - 1; 
                distancia += matriz[cidadeA][cidadeB];
            }
            return distancia;
        }

        function selecaoTorneio(populacao, tamTorneio) {
            let melhorDoTorneio = null;
            for (let i = 0; i < tamTorneio; i++) {
                const idxAleatorio = Math.floor(Math.random() * populacao.length);
                const individuo = populacao[idxAleatorio];
                
                if (melhorDoTorneio === null || individuo.fitness > melhorDoTorneio.fitness) {
                    melhorDoTorneio = individuo;
                }
            }
            return melhorDoTorneio;
        }

        function crossoverPMX(pai1, pai2) {
            const p1 = pai1.slice(1, -1);
            const p2 = pai2.slice(1, -1);
            const n = p1.length;
            
            if (n < 2) {
                 return [pai1, pai2]; 
            }

            const f1 = Array(n).fill(-1);
            const f2 = Array(n).fill(-1);

            let corte1 = Math.floor(Math.random() * n); 
            let corte2 = Math.floor(Math.random() * n);
            if (corte1 > corte2) {
                [corte1, corte2] = [corte2, corte1];
            } else if (corte1 === corte2) {
                 corte2 = (corte1 + 1) % n;
                 if (corte1 > corte2) {
                    [corte1, corte2] = [corte2, corte1];
                 }
            }

            const map1 = {};
            const map2 = {};

            for (let i = corte1; i <= corte2; i++) {
                f1[i] = p2[i];
                f2[i] = p1[i];
                map1[p2[i]] = p1[i];
                map2[p1[i]] = p2[i];
            }

            for (let i = 0; i < n; i++) {
                if (i >= corte1 && i <= corte2) continue;

                let cidade1 = p1[i];
                while (f1.includes(cidade1)) {
                    cidade1 = map1[cidade1];
                }
                f1[i] = cidade1;

                let cidade2 = p2[i];
                while (f2.includes(cidade2)) {
                    cidade2 = map2[cidade2];
                }
                f2[i] = cidade2;
            }

            return [ [1, ...f1, 1], [1, ...f2, 1] ];
        }

        function mutacaoTroca(rota) {
            const rotaMutavel = rota.slice(1, -1); 
            const n = rotaMutavel.length;
            if (n < 2) return rota; 

            const idx1 = Math.floor(Math.random() * n);
            let idx2 = Math.floor(Math.random() * n);
            
            while (idx1 === idx2) {
                idx2 = Math.floor(Math.random() * n);
            }

            [rotaMutavel[idx1], rotaMutavel[idx2]] = [rotaMutavel[idx2], rotaMutavel[idx1]];

            return [1, ...rotaMutavel, 1];
        }

        btnGerarMatrizEl.click();

    </script>
</body>

</html>
